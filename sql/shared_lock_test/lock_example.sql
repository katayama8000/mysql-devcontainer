-- 2つのMySQLセッションで共有ロック機能を試すためのスクリプト

-- セッション1: 共有ロックをかける
-- ---------------------------------------
-- MySQLコマンドラインなどで、最初のセッションを開いて以下のコマンドを順番に実行します。
-- これにより、`users`テーブルの`id = 1`の行に共有ロックがかかります。
-- このロックは、他のセッションが同じ行に共有ロックをかけることは許可しますが、排他ロック（更新や削除）をかけることは防ぎます。

-- 使用するデータベースを指定
USE mydatabase;

-- トランザクションを開始
START TRANSACTION;

-- `id = 1`の行に共有ロックをかける
-- このコマンドはデータを読み取るだけで、他のセッションからの読み取りをブロックしません。
SELECT * FROM users WHERE id = 1 FOR SHARE;


-- ここでセッション2に切り替えます。
-- セッション1は、次のCOMMIT文が実行されるまでロックを保持し続けます。


-- セッション2: ロックされた行の読み取りと更新を試みる
-- ---------------------------------------
-- 2つ目のMySQLセッションで、以下のコマンドを実行します。

-- 読み取り（共有ロック）
-- このコマンドは正常に完了します。共有ロックは、他のセッションからの読み取りをブロックしないためです。
-- USE mydatabase;
-- SELECT * FROM users WHERE id = 1 FOR SHARE;


-- 更新（排他ロック）
-- このコマンドは、セッション1がロックを解除するまで待機状態になります。
-- 共有ロックがかかっているため、排他ロックをかけることはできません。
-- USE mydatabase;
-- UPDATE users SET age = 40 WHERE id = 1;


-- セッション1に戻る: ロックを解除する
-- ---------------------------------------
-- セッション1に戻り、以下のコマンドを実行してロックを解除します。
-- ロックが解除されると、セッション2のUPDATE文が自動的に完了します。

-- COMMIT;


-- 最終的なテーブルの状態を確認
-- ---------------------------------------
-- ロック解除後に以下のコマンドを実行して、変更が適用されたことを確認します。
-- SELECT * FROM users WHERE id = 1;
